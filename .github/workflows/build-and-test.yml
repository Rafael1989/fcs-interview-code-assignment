name: Build, Test & Validate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-test-validate:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['17']

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: maven

    - name: Build, Test and Validate Code Coverage with Maven
      run: mvn clean verify -B
      working-directory: ./java-assignment
      # Note: mvn verify includes:
      #   - Compilation
      #   - Unit tests execution
      #   - JaCoCo coverage report generation
      #   - JaCoCo check validation (80%+ minimum enforced by pom.xml configuration)

    - name: Generate JaCoCo coverage report (additional)
      run: mvn jacoco:report -B
      working-directory: ./java-assignment
      continue-on-error: true

    - name: Display JaCoCo Coverage Report Summary
      run: |
        echo "==============================================="
        echo "    JaCoCo Code Coverage Report Summary"
        echo "==============================================="
        if [ -f ./java-assignment/target/site/jacoco/index.html ]; then
          echo ""
          echo "‚úÖ JaCoCo Report Generated Successfully"
          echo ""
          echo "üìä Coverage Metrics:"
          echo ""
          
          # Parse and display coverage from jacoco.csv if available
          if [ -f ./java-assignment/target/site/jacoco/jacoco.csv ]; then
            # Extract coverage data from CSV
            COVERAGE_LINE=$(grep -v "^GROUP,PACKAGE,CLASS" ./java-assignment/target/site/jacoco/jacoco.csv | head -1)
            
            # Parse instruction coverage
            INST_MISSED=$(echo "$COVERAGE_LINE" | cut -d',' -f4)
            INST_COVERED=$(echo "$COVERAGE_LINE" | cut -d',' -f5)
            INST_TOTAL=$((INST_MISSED + INST_COVERED))
            if [ $INST_TOTAL -gt 0 ]; then
              INST_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($INST_COVERED/$INST_TOTAL)*100}")
              echo "   Instruction Coverage: $INST_PERCENT% ($INST_COVERED/$INST_TOTAL)"
            fi
            
            # Parse branch coverage
            BRANCH_MISSED=$(echo "$COVERAGE_LINE" | cut -d',' -f6)
            BRANCH_COVERED=$(echo "$COVERAGE_LINE" | cut -d',' -f7)
            BRANCH_TOTAL=$((BRANCH_MISSED + BRANCH_COVERED))
            if [ $BRANCH_TOTAL -gt 0 ]; then
              BRANCH_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($BRANCH_COVERED/$BRANCH_TOTAL)*100}")
              echo "   Branch Coverage: $BRANCH_PERCENT% ($BRANCH_COVERED/$BRANCH_TOTAL)"
            fi
            
            # Parse line coverage
            LINE_MISSED=$(echo "$COVERAGE_LINE" | cut -d',' -f8)
            LINE_COVERED=$(echo "$COVERAGE_LINE" | cut -d',' -f9)
            LINE_TOTAL=$((LINE_MISSED + LINE_COVERED))
            if [ $LINE_TOTAL -gt 0 ]; then
              LINE_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($LINE_COVERED/$LINE_TOTAL)*100}")
              echo "   Line Coverage: $LINE_PERCENT% ($LINE_COVERED/$LINE_TOTAL)"
            fi
            
            # Parse method coverage
            METHOD_MISSED=$(echo "$COVERAGE_LINE" | cut -d',' -f10)
            METHOD_COVERED=$(echo "$COVERAGE_LINE" | cut -d',' -f11)
            METHOD_TOTAL=$((METHOD_MISSED + METHOD_COVERED))
            if [ $METHOD_TOTAL -gt 0 ]; then
              METHOD_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($METHOD_COVERED/$METHOD_TOTAL)*100}")
              echo "   Method Coverage: $METHOD_PERCENT% ($METHOD_COVERED/$METHOD_TOTAL)"
            fi
            
            # Parse class coverage
            CLASS_MISSED=$(echo "$COVERAGE_LINE" | cut -d',' -f12)
            CLASS_COVERED=$(echo "$COVERAGE_LINE" | cut -d',' -f13)
            CLASS_TOTAL=$((CLASS_MISSED + CLASS_COVERED))
            if [ $CLASS_TOTAL -gt 0 ]; then
              CLASS_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($CLASS_COVERED/$CLASS_TOTAL)*100}")
              echo "   Class Coverage: $CLASS_PERCENT% ($CLASS_COVERED/$CLASS_TOTAL)"
            fi
          fi
          
          echo ""
          echo "==============================================="
          echo "‚úÖ Coverage Status: PASSED (80%+ requirement met)"
          echo "==============================================="
          echo ""
          echo "üìÑ View Full Report:"
          echo "   1. Download artifact 'jacoco-coverage-report' from this workflow run"
          echo "   2. Codecov Dashboard:"
          echo "      https://codecov.io/gh/${{ github.repository }}"
          echo "   3. Local: java-assignment/target/site/jacoco/index.html"
          echo ""
          echo "==============================================="
        else
          echo "‚ö†Ô∏è JaCoCo report not found at:"
          echo "   java-assignment/target/site/jacoco/index.html"
          exit 1
        fi
      continue-on-error: false

    - name: Upload JaCoCo Coverage Report as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-coverage-report
        path: ./java-assignment/target/site/jacoco/
        retention-days: 30
      if: always()

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./java-assignment/target/site/jacoco/jacoco.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false


  code-quality:
    runs-on: ubuntu-latest
    needs: build-test-validate

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Analyze with SonarQube
      run: |
        mvn clean verify sonar:sonar \
          -Dsonar.projectKey=fcs-interview-assignment \
          -Dsonar.sources=src/main \
          -Dsonar.tests=src/test \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }} || true
      working-directory: ./java-assignment
      continue-on-error: true

  security-scan:
    runs-on: ubuntu-latest
    needs: build-test-validate

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Run OWASP dependency check
      run: mvn org.owasp:dependency-check-maven:check -B
      working-directory: ./java-assignment
      continue-on-error: true


